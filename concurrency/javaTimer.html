<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>The Java Timer</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>The Java Timer</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Here I want to study the <code>java.util.Timer</code> class (henceforth just <code>Timer</code>) and distill it to its fundamentals. I want to answer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How does it essentially work?</p>
</li>
<li>
<p>What concurrency mechanisms does it use?</p>
</li>
<li>
<p>Could you roll out your own implementation, or is it some sort of native concept that ships with the java language itself and cannot be replicated in user code?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Yes. You can definitely roll out your own! Like all things concurrency, you shouldn&#8217;t use your own implementation in production, but actually being able to do develop one from scratch makes you feel incredibly competent, reduces the angst of using concepts like a black-box, and guides your judgement when you do use external code that deals with this for you.</p>
</div>
<div class="ulist">
<div class="title">Summary - TLDR</div>
<ul>
<li>
<p>Every <code>Timer</code> that is instantiated starts a thread. A <span class="underline">single</span> new thread.</p>
<div class="ulist">
<ul>
<li>
<p>The thread is essentially a <code>while(true)</code> loop over a queue of tasks.</p>
</li>
<li>
<p>The thread is responsible for both running the tasks, and deciding when to run the next task.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The <span class="underline">native</span> method <code>wait(&lt;timeout&gt;)</code> - present on every Java object - is the mechanism by which the thread can sleep until the next task is due.</p>
<div class="ulist">
<ul>
<li>
<p>Correspondingly, the <span class="underline">native</span>  method <code>notify()</code> is the mechanism by which the thread can be "waken up, if during its sleep," a new task is submitted that ought to run sooner.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_mvp_of_a_timer">The MVP of a <code>Timer</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of a timer is to receive and manage tasks with deferred and/or periodic execution. Given an instance, you want to give it a task "to run 1 minute from now", or "every 30 seconds."</p>
</div>
<div class="paragraph">
<p>These tasks need to run on threads, these being the basic unit to "run things". It also doesn&#8217;t make much sense to run these tasks on the same thread that submits the task. Or else the thread would have to stop whatever it was doing to focus on running the task, which doesn&#8217;t seem useful. The question is then if we should have a single thread, multiple threads, or some kind of thread pool. Regardless, this is enough to realize that we need some kind of data structure by means of which the thread that submits the task, can actually pass the task to the thread(s) that run it.</p>
</div>
<div class="paragraph">
<p>The most basic form of a timer is therefore a lonely thread whose sole purpose is to loop over some data structure that contains tasks to run. Evidently, that data structure is shared with the other "producer" threads which have a reference to the timer and that submit the tasks. The latter are like clients of the timer:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Overview.svg" alt="Overview">
</div>
<div class="title">Figure 1. High-level representation of how a timer works internally.</div>
</div>
<div class="paragraph">
<p>It turns out, the <code>Timer</code> class is very much well represented in the above diagram. In particular, a <code>Timer</code> is associated with a <strong>SINGLE</strong> thread. Every time you create a new instance, a new thread is created. That thread goes on an infinite loop. On each iteration it checks if there is a task that it should run. It executes it if there is, and then proceeds to the next iteration. This is essentially it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Since Java 5.0 (2004), <code>Timer</code> went out of favor with the introduction of <code>java.util.concurrent.ScheduledThreadPoolExecutor</code>. The latter is more versatile, but unless you need its extra-capabilities, <code>Timer</code> is more than adequate. For example, <code>ScheduledThreadPoolExecutor</code> is an interface rather than a concrete class, with all the advantages that brings.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notice in particular you can have many clients of a <code>Timer</code>. That is, many parts of your code base with a reference to the same object. Each may submit tasks, and be running on a different thread. This demands the "shared data structure" be thread-safe.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_your_own">Implementing your own</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are 4 public methods.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Timer API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Timer {
    public void schedule(TimerTask task, long delay) {/* impl */}
    public void schedule(TimerTask task, long delay, long period) {/* impl */}
    public void scheduleAtFixedRate(TimerTask task, long delay, long period) {/* impl */}
    public void cancel() {/* impl */}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>These methods are what the client threads are allowed to call. As a sidenote, notice that the client has no direct control over the underlying "shared data structure" or thread. These were set up "under the hood" upon object creation of the <code>Timer</code> instance. By the time a client calls any of these methods, the timer thread is already doing its business: looping around the "shared data structure", eager for tasks to run.</p>
</div>
<div class="paragraph">
<p>The two methods with the <code>period</code> parameter are for <strong>periodic</strong> tasks. The difference between will be explained later.<br>
We will focus on the first method. It&#8217;s the simplest, but still requires us to address the fundamentals of the challenge that underpins timers: How to schedule the tasks.  It&#8217;s here where we lift the veil of magic. The other two scheduling methods introduce no fundamental new challenge. <code>cancel()</code> is also important.</p>
</div>
<div class="paragraph">
<p><code>TimerTask</code> above is a concept which exists for the purpose of <code>Timer</code>. It is essentially a <code>Runnable</code>. Lets not dwell too much on it. Not overly relevant to the core understanding.</p>
</div>
<div class="sect2">
<h3 id="_attempt_1_naive_approach">Attempt 1 - Naive approach</h3>
<div class="paragraph">
<p>We need the following:<br>
1. Thread safe data structure.<br>
2. One thread looping over that data structure endlessly.</p>
</div>
<div class="paragraph">
<p>(We will follow with Scala source code. The syntax is different, but in practise its the same thing)</p>
</div>
<details>
<summary class="title">Attempt 1 - Naive approach</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import java.util.concurrent.{BlockingQueue, LinkedBlockingQueue}

class CustomTimer private (queue: BlockingQueue[(Runnable, Long)]) {
  def schedule(runnable: Runnable, delay: Long): Unit = {
    val task = (runnable, System.currentTimeMillis() + delay)
    queue.put(task)
  }
}

object CustomTimer {

  def apply(threadName: String): CustomTimer = {
    val queue = new LinkedBlockingQueue[(Runnable, Long)]()

    def mainLoop(): Unit =
      while (true) {
        val tuple @ (runnableTask, whenToRun) = queue.take()
        if (System.currentTimeMillis() &gt; whenToRun) runnableTask.run()
        else queue.put(tuple)
      }

    val timerThread = new Thread(new Runnable { def run(): Unit = mainLoop() })
    timerThread.setName(threadName)
    timerThread.setDaemon(false)
    timerThread.start()
    new CustomTimer(queue)
  }
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Hopefully I didn&#8217;t disappoint in leveraging the existing <code>BlockingQueue/LinkedBlockingQueue</code>. Developing one from scratch would be very instructive, but this is a beast on its own.</p>
</div>
<div class="paragraph">
<p>For all its cons, an advantage of this approach is that the thread will not waste CPU time when there are no tasks submitted. This is a nice advantage of using a blocking queue, which puts the thread calling <code>queue.take</code> on a "waiting" state until a timer client pushes a new element/task to the queue.</p>
</div>
<div class="paragraph">
<p>We can see that by profiling the thread state:</p>
</div>
<details>
<summary class="title">spin method. Useful for tests. Used throughout.</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import scala.concurrent.duration._

def spin(duration: Duration): Unit = {
  val stopSpinning = System.currentTimeMillis() + duration.toMillis
  while (System.currentTimeMillis() &lt; stopSpinning) {}
}</code></pre>
</div>
</div>
</div>
</details>
<details id="threadSleepsWhenQueueEmpty">
<summary class="title">Thread "sleeps" when queue is empty</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import scala.concurrent.duration._

object SomeTests extends App {
  val customTimer = CustomTimer("FooBarThread") // <b class="conum">(1)</b>

  spin(1.minute) // <b class="conum">(2)</b>

  customTimer.schedule(
    new Runnable { def run(): Unit = spin(20.seconds) },
    30.second.toMillis
  )

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>By the time this constructor returns, the timer thread is already up and running.</p>
</li>
<li>
<p>Note, this call happens on the main thread, which is different from the timer thread.</p>
</li>
</ol>
</div>
</div>
</details>
<div class="imageblock">
<div class="content">
<img src="./images/TimerThreadLane-Attempt1.svg" alt="TimerThreadLane Attempt1">
</div>
<div class="title">Figure 2. States of the timer thread for the listing <a href="#threadSleepsWhenQueueEmpty">above</a>. No tasks on the queue, means the thread will be in a waiting state, whereby the CPU will not run it.</div>
</div>
<div class="paragraph">
<p>Are you surprised of the usage of <code>System.currentTimeMillis()</code> to help schedule the tasks? Don&#8217;t be. <code>Timer</code> uses the exact same mechanism.</p>
</div>
<div class="paragraph">
<p>The biggest disadvantage of this attempt is that when there are pending tasks (i.e. the queue is not empty) the timer thread is needlessly active. The thread will be assigned CPU time, although nothing  of value is running until the next task has to be run: If you submit a single task to run 30 minutes from now, for the next 30 minutes, the thread will be continuously looping around.</p>
</div>
<div class="paragraph">
<p>There is an implicit requirement:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>The timer thread should not waste CPU time <strong>UNTIL</strong> the next task is scheduled to run.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>This is indeed what <code>Timer</code> does. The diagram shows what the timer thread is doing for the code at [1]:</p>
</div>
<details id="twoTasksScheduled">
<summary class="title">Scheduling of two tasks</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import java.util.{Timer, TimerTask}
import scala.concurrent.duration._

object SomeTests extends App {

  val javaTimer = new Timer("FooBarTimer") // <b class="conum">(1)</b>

  javaTimer.schedule(
    new TimerTask { def run() = spin(20.second) },
    30.second.toMillis
  )

  javaTimer.schedule(
    new TimerTask { def run() = spin(20.second) },
    90.second.toMillis
  )
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>By the time this constructor returns, the timer thread is already up and running.</p>
</li>
</ol>
</div>
</div>
</details>
<div id="javaTimerTwoTasksScheduled" class="imageblock">
<div class="content">
<img src="./images/TimerThreadLane.svg" alt="TimerThreadLane">
</div>
<div class="title">Figure 3. States of the thread of a <code>java.util.Timer</code> for the listing <a href="#twoTasksScheduled">above</a>.</div>
</div>
<div class="paragraph">
<p>The timer (and therefore associated thread) is created at around time 0, and immediately after two tasks are submitted. Task 1, schedule to run 30 seconds from now and Task 2, schedule to run 90 seconds from now. Both tasks are just a while loop for 20 seconds.</p>
</div>
<div class="paragraph">
<p><strong>Importantly note</strong><br>
1. For the 1st 30 seconds, there is nothing to do. Adequately the thread sleeps and does not wast CPU. "It knows" exactly when to wake back up.<br>
2. After it runs, it goes back to idle until Task 2 is meant to run.<br>
3. After running Task 2, as there are no more tasks submitted, it correctly goes bak to a "Waiting state".</p>
</div>
</div>
<div class="sect2">
<h3 id="_attempt_2">Attempt 2</h3>
<div class="paragraph">
<p>We could improve our custom <a href="#_attempt_1_naive_approach">Attempt 1 - Naive approach</a>, by calling <code>Thread.sleep(&lt;duration&gt;)</code>, where <code>duration</code> would be the time interval until the next task is meant to run. That is, on each iteration we take the task which should run next, and then put the thread to sleep until it should run. when it wakes, the thread then runs it, and moves on to the next iteration.<br>
The problem is we would miss-schedule tasks the clients submit <strong>after</strong> the timer thread goes to the sleep state. Is there a mechanism for the thread sleeping after <code>Thread.sleep()</code> to woken up?</p>
</div>
<div class="paragraph">
<p>In other words, the question is:</p>
</div>
<div class="paragraph">
<p>Relative to the previous <a href="#javaTimerTwoTasksScheduled">scenario</a>, what would happen if some client - on a different thread - submitted a task <strong>at</strong> 60 seconds, when the timer thread was waiting to run Task 2, and such that this new task has a scheduled time of 10 seconds (meaning, it should run at time 70 seconds)?</p>
</div>
<div class="paragraph">
<p>Sadly, in our purposed approach with <code>Thread.sleep()</code>, the timer would run Task 3 at best at 90 seconds, once it awakens.</p>
</div>
<div class="paragraph">
<p>By contrast, the <code>Timer</code> correctly wakes up prematurely, and is able to run Task 3 <strong>before</strong> Task 2:</p>
</div>
<details id="submitNewTaskWhenThreadIsWaitingForAnother">
<summary class="title">Submitting a task due sooner</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import java.util.{Timer, TimerTask}
import scala.concurrent.duration._

object SomeTests extends App {

  val javaTimer = new Timer("FooBarTimer") // <b class="conum">(1)</b>

  javaTimer.schedule(
    new TimerTask { def run() = spin(20.second) },
    30.second.toMillis
  )

  javaTimer.schedule(
    new TimerTask { def run() = spin(20.second) },
    90.second.toMillis
  )

  spin(60.seconds) // <b class="conum">(2)</b>

  javaTimer.schedule(
    new TimerTask { def run() = spin(10.second) },
    10.second.toMillis
  )
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>By the time this constructor returns, the timer thread is already up and running.</p>
</li>
<li>
<p>Notice that this is the main thread, the only "client" of the <code>Timer</code> instance.</p>
</li>
</ol>
</div>
</div>
</details>
<div class="imageblock">
<div class="content">
<img src="./images/TimerThreadLane-ExtraTask.svg" alt="TimerThreadLane ExtraTask">
</div>
<div class="title">Figure 4. States of the timer thread of a <code>java.util.Timer</code> for the listing <a href="#submitNewTaskWhenThreadIsWaitingForAnother">above</a>.</div>
</div>
<div class="paragraph">
<p>But wait, there is more. Notice dashed line at 60 seconds, when Task 3 is introduced? Well, if we were to zoom-in, we would notice that the thread wakes up for a very brief period of time In the order of microseconds. This is necessary off course to verify when the ew Task 3 has to be run and take appropriate action.</p>
</div>
<div class="paragraph">
<p>This seems rather magical. The timer thread, which is effectively not running when Task 3 is submitted, wakes up as a result of the submission and then 1) processes the new task, 2) understands it should run earlier than Task 2, and then 3) goes back to sleep until is due date.</p>
</div>
<div class="paragraph">
<p>This is off course what you would intuitively expect. We should augment the previous requirement.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>The timer thread should not waste CPU time <strong>UNTIL</strong> the next task is scheduled to run, <strong>OR UNTIL</strong> a new task is submitted in the meantime, such that it is to be run before the former.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>This is where the buck stops, at least for the java programmer.<br>
It is here that we meet the interface between our source code (be it Java/Scala/Kotlin) and the underlying system (JVM, OS, Hardware) occurs.<br>
The same way you ultimately need the JVM to have antive code to handle the file system, or network calls for us, here we must also rely on the JVM to be able to do funny things with thread scheduling.<br>
In turn, the JVM will call the underlying OS for this, give that threads as a concept of the OS.</p>
</div>
<div class="paragraph">
<p>What is exposed by the JVM is the concept of the native methods <code>wait()</code>, <code>wait(&lt;timeout&gt;)</code>, <code>notify()</code>, and <code>notifyAll()</code>.<br>
Most likely, some of the people reading already know these.These exist on every Java object, and are the bedrock to for all concurrent things on the JVM. In this article, we won&#8217;t be exploring these methods - although that would be VERY interesting. Let&#8217;s just take them as dogma.</p>
</div>
<div class="paragraph">
<p>With them, I am able to meet the requirement above.</p>
</div>
<details id="firstSeriousSolution">
<summary class="title">A serious solution</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import java.util.Comparator
import java.util.concurrent.{BlockingQueue, PriorityBlockingQueue}

class CustomTimer private (lock: Object, queue: BlockingQueue[(Runnable, Long)]) {
  def schedule(runnable: Runnable, delay: Long): Unit = {
    val thisTask = (runnable, System.currentTimeMillis() + delay)
    queue.put(thisTask)
    if (queue.peek() == thisTask) {
      lock.synchronized {
        lock.notify() // <b class="conum">(1)</b>
      }
    }
  }
}

object CustomTimer {

  private def comparator: Comparator[(Runnable, Long)] =  // <b class="conum">(2)</b>
    new Comparator[(Runnable, Long)] {
      def compare(o1: (Runnable, Long), o2: (Runnable, Long)): Int =
        (o1._2 - o2._2).toInt
    }

  def apply(threadName: String): CustomTimer = {
    val lock: Object = new Object()
    val queue = new PriorityBlockingQueue[(Runnable, Long)](10, comparator)

    def mainLoop(): Unit =
      while (true) {
        val tuple @ (runnableTask, whenToRun) = queue.take()
        val timeToWait = whenToRun - System.currentTimeMillis()
        if (timeToWait &lt;= 0) runnableTask.run()
        else {
          lock.synchronized {
            lock.wait(timeToWait) // <b class="conum">(1)</b>
          }
          queue.offer(tuple)
        }
      }

    val timerThread = new Thread(new Runnable { def run(): Unit = mainLoop() })
    timerThread.setName(threadName)
    timerThread.setDaemon(false)
    timerThread.start()
    new CustomTimer(lock, queue)
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>They dance together</p>
</li>
<li>
<p>The <code>PriorityBlockingQueue</code> needs this to be able to sort the elements by priority.</p>
</li>
</ol>
</div>
</div>
</details>
<div class="paragraph">
<p>The <code>lock.notify()</code> and <code>lock.wait(&lt;timeout&gt;)</code> play the dance together.<br>
The timer thread takes the next task to run.<br>
The <code>lock.wait(&lt;timeout&gt;)</code> puts the timer thread in a waiting state - what we want. it solves <strong>both</strong> problems. It will wake up either when the timeout expires, or when some other thread calls <code>notify()</code> (or <code>notifyAll()</code>) on that same object <code>lock</code>.</p>
</div>
<div class="paragraph">
<p>Lets see how this solution deals with example (example). Lets make the starting point when the timer thread is executing Task 1. At that moment, Task 2 is already on the queue, but Task 3 isn&#8217;t.<br>
Once the timer thread finishes, it begins another iteration of the loop. It removes Task 2 (at that point the only task left) and falls into the <code>else</code> branch. It enter the <code>synchronized</code> block and calls the wait method with timeout <code>90s-50s=30s</code>. At this point the timer thread goes into the waiting state. It is being scheduled by the OS. At same point later, but before those 30 seconds go by, the timer thread is still asleep when a client, on another thread, submits a new task. Because this new task is next task to run (being it the only one on the queue), the <code>schedule</code> method will enter the <code>if</code> block. There, it acquires the lock. This is alright, becuase the timer thread relishendit the lock once it called <code>wait(30s)</code>. Immedtiatly after, it calls <code>lock.notify()</code>. This has the power to wake up the our timer thread. Recall that by the semantics of <code>Object.wait()</code>, the thread wakes up when the timeout expires where when some other thread calls <code>notify</code>.<br>
After the timer thread wakens, the objective is to check <strong>which</strong> is the new task to run. There are two options. The original task (Task 2), or the new task inserted by the client (Task 3).<br>
To that end, after the timer thread awakens, it continues where it left off. After exiting the synchronized block, it inserts the Task 2 back into the shared queue, and then starts another loop iteration. At the point it takes an element from the queue, both tasks Task 2 and Task 3 will be present there. The one taken is the shorter of the 2. Recall that the responsability of sorting the queue correctly was deferred to the <code>java.util.concurrent.PriorityBlockingQueue</code> (for convenience. We can do that ourselves). Because of this, Task 3 will be the one removed from the queue. Still, it is not yet time for the task to run. So we go again onto the <code>else</code> branch and call <code>lock.wait(10.s)</code>. Because there are no more clients submitting tasks, there is no more calls to <code>lock.notify()</code>, and the only way for the timer thread to wake up is when the timeout expires.<br>
After it wakes up, it should run the task. For the purposes of this example, we isntead offer it back to the queue. That&#8217;s fine, because the thread noe begins another iteration of the loop, and it will take the same Task 3 again. By then <code>timeToWait</code> will be negative and finally Task 3 is run. After Task 3 completes, we are back again on a new iteration. By now, only Task 2 remains on the queue. On take it, and the process repeats itself.</p>
</div>
<div class="paragraph">
<p>Notice that, if clients schedule new tasks which are not inserted at the ehad of the preiority queue, then the timer thread will not be awaken (in case it was waiting).</p>
</div>
<div class="sect3">
<h4 id="_a_bug">A bug</h4>
<div class="paragraph">
<p>The previously solution has a race condition. Its not a big bug. The solution is still very decent. But probably you wouldn&#8217;t want to use it in production. Well, but that is already an assumption on everything we have been doing. Do you want to try to identify the race condition?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cancellation">Cancellation</h3>
<div class="paragraph">
<p>Most people nowadays work in the context of existing web server applications which are meant to run forever. Because we are less exposed to this issue of shutting a system down, its importance is underrated. However, cancellation and end-of-lifecycle behaviour for a standalone timer (or any executor service) is a critical feature.</p>
</div>
<div class="paragraph">
<p>What do we mean by cancellation? We want the timer to stop running tasks, and for the associated resources to be released, which will mean at least the timer thread terminates. We also want the cancellation to be reliable, predictable, safe. Well, that goes without saying. What those things mean in this context however, is still to be determined.</p>
</div>
<div class="paragraph">
<p>When a client asks for cancellation, the system might be in four major states.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>One task is running, but no more tasks are scheduled.</p>
</li>
<li>
<p>One is running, and additional tasks are scheduled.</p>
</li>
<li>
<p>No task running, and no more tasks scheduled.</p>
</li>
<li>
<p>No task running, but some tasks scheduled.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/OverviewWithCancellation.svg" alt="OverviewWithCancellation">
</div>
<div class="title">Figure 5. Revisiting the high-level representation. Plus cancellation.</div>
</div>
<div class="paragraph">
<p>This raises questions.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Do we try to cancel an actively running task?</p>
<div class="ulist">
<ul>
<li>
<p>Is it even possible to cancel an actively running task?</p>
</li>
</ul>
</div>
</li>
<li>
<p>If we let it run, do we also run the additional tasks on the queue?</p>
</li>
<li>
<p>If yes, do we allow new tasks to be submitted if they are scheduled to run before the last one? (The last one being the latest task at the time of the cancellation request)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Starting in reverse order. On question 3, the answer is <strong>no</strong>. For <code>Timer</code> and also for  <code>ScheduledExecutorService</code>. Once cancellation is requested, no more tasks can be added. Any further submissions result in an exception. We will follow that as well.</p>
</div>
<div class="paragraph">
<p>For question 2, that is up for debate. What would you expect as a user?<br>
Turns out, <code>Timer</code> will <strong>not</strong> run any task already scheduled if it is not already running. In contrast, a <code>ScheduledExecutorService</code> has two methods: <code>shutdown()</code> and <code>shutdownNow()</code>. The former runs all queued tasks. If a queued task is scheduled to run in 10 hours, then at least for those 10 hours the service will be running. The latter will discard them. We will follow <code>Timer</code>.</p>
</div>
<div class="paragraph">
<p>Lastly, regarding any possible task running at the time of cancellation, <code>Timer</code> will not interfere. Meaning it will not even <em>try to cancel</em>  it. The same is true for <code>ScheduledExecutorService#shutdown()</code>. In comparison, <code>shutdownNow()</code> will indeed <em>try to cancel</em>  the task.<br>
The wording <em>try to cancel</em> is appropriate. In general we can&#8217;t stop a running task. There is no absolute mechanism to do so. Ultimately it is up to the task itself (the <code>Runnable</code> instance). More on this later.</p>
</div>
<div class="sect3">
<h4 id="_getting_on_with_it">Getting on with it</h4>
<div class="paragraph">
<p>The most straightforward approach is to use a flag; set by the client thread, and read by the timer thread. It must account for the fact that it will be accessed by multiple threads (at least one of the accesses being a write). In this situation, tagging a boolean as <code>@volatile</code> would be the least powerful solution. However, because of the way I set up things, the <code>mainLoop()</code> method is not on the same scope as the <code>cancel()</code> method, and makes this awkward. I use <code>AtomicBoolean</code> instead; effectively a more powerful construct than needed.</p>
</div>
<details id="cancellationFirstAttempt">
<summary class="title">Cancellation - First try. Builds on top of previous listing <a href="#firstSeriousSolution">A serious solution</a></summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="diff" class="language-diff hljs">import java.util.Comparator
+ import java.util.concurrent.atomic.AtomicBoolean
import java.util.concurrent.{BlockingQueue, PriorityBlockingQueue}

class CustomTimer private (
+ shutdown: AtomicBoolean,
  lock: Object,
  queue: BlockingQueue[(Runnable, Long)]
) {

+ def cancel(): Unit = shutdown.set(true)

  def schedule(runnable: Runnable, delay: Long): Unit = {
+   if (shutdown.get()) throw new IllegalArgumentException("Timer already cancelled.")
    val thisTask = (runnable, System.currentTimeMillis() + delay)
    queue.put(thisTask)
    if (queue.peek() == thisTask) {
      lock.synchronized {
        lock.notify()
      }
    }
  }
}

object CustomTimer {

  private def comparator: Comparator[(Runnable, Long)] =
    new Comparator[(Runnable, Long)] {
      def compare(o1: (Runnable, Long), o2: (Runnable, Long)): Int =
        (o1._2 - o2._2).toInt
    }

  def apply(threadName: String): CustomTimer = {
+   val shutdown = new AtomicBoolean(false)
    val lock: Object = new Object()
    val queue = new PriorityBlockingQueue[(Runnable, Long)](10, comparator)

    def mainLoop(): Unit =
-     while (true) {
+     while (!shutdown.get()) {
        val tuple @ (runnableTask, whenToRun) = queue.take()
        val timeToWait = whenToRun - System.currentTimeMillis()
        if (timeToWait &lt;= 0) runnableTask.run()
        else {
          lock.synchronized {
            lock.wait(timeToWait)
          }
          queue.offer(tuple)
        }
      }

    val timerThread = new Thread(new Runnable { def run(): Unit = mainLoop() })
    timerThread.setName(threadName)
    timerThread.setDaemon(false)
    timerThread.start()
-   new CustomTimer(lock, queue)
+   new CustomTimer(shutdown, lock, queue)
  }
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>This solution is decent enough, but a slight problem makes it not really fit for production.</p>
</div>
<details>
<summary class="title">Problem 1. Program runs forever.</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">object SomeTests extends App {
  val javaTimer = CustomTimer("FooBarTimer")
  Thread.sleep(1) // <b class="conum">(1)</b>
  javaTimer.cancel()
} // <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This hack tries to ensure the timer thread enters the loop before cancellation is requested</p>
</li>
<li>
<p>Thread <code>main</code> exits here. What about other threads of the program?</p>
</li>
</ol>
</div>
</div>
</details>
<div class="paragraph">
<p>The program above would never terminate.<br>
The problem is that if cancellation is requested when the queue is empty - which will definitely happen because a client has no way of knowing the state of the queue - then the timer thread blocks at <code>queue.take()</code>. The thread goes into a waiting state, from which it would not wake up unless a client submitted a new task. Because the JVM does not shutdown until all non-daemon threads have finished, and because our timer thread is non-daemon and is still active (despite being blocked), then the program never terminates. This behaviour would cause enormous confusion in an even small code base.</p>
</div>
<details>
<summary class="title">Problem 2. Program runs for 10 hours and then does not run the task.</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import java.util.TimerTask
import scala.concurrent.duration._

object SomeTests extends App {
  val javaTimer = CustomTimer("FooBarTimer")

  javaTimer.schedule(
    new TimerTask { def run() = spin(10.second) },
    10.hours.toMillis
  )

  javaTimer.cancel()
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Similarly, if there are still tasks to run when cancellation is requested, then the timer thread might be blocked at <code>lock.wait(timeWait)</code>, waiting to run. In this scenario, the thread only has a chance to see the updated shutdown flag after <code>timeWait</code> expires and then exit the loop, terminating the thread. If <code>timeWait</code> is 10 hours, then the JVM program will exit after 10 hours.<br>
This is similar to what happens for the equivalent method <code>ScheduledThreadPoolExecutor#shutdown()</code> (but not for <code>shutdownNow()</code>). Off course in that case, the executor would wait 10 hours <strong>but</strong> actually run the associated task, which is the documented behaviour for that method; whilst here we would wait 10 hours <strong>and never</strong> run it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_case_for_threadinterrupt">The case for <code>Thread#interrupt()</code></h4>
<div class="paragraph">
<p>The underlying problem is the call to those two blocking methods prevents the flag from being read. We could solve the second problem - when the tread is held at <code>lock.wait(timeWait)</code> - with relative ease. The problem is that after <code>cancel()</code> is called the lock will never wake prematurely. Therefore, we could make <code>cancel()</code> act the same way as the <code>schedule()</code>: enter the lock, and then notify the timer thread.</p>
</div>
<details>
<summary class="title">Partial Fix</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">def cancel(): Unit = {
  shutdown.set(true)
  lock.synchronized {
    lock.notify()
  }
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Because now we enter the same lock that the timer thread is waiting one, we are able to wake up the thread prematurely which will then be able to read the updated flag. This is exactly the approach that <code>Timer</code> takes.<br>
In our case the solution is not fully water-proof because it only works if the timer thread is <strong>already</strong> blocked at <code>lock.wait(timeWait)</code>. If the timer thread is already inside a loop iteration <strong>but</strong> hasn&#8217;t entered the lock yet, we go back to the same problem. This is a race condition. The time window for this to occur is very small, but exists. It can be fixed by making a few smart changes on the <code>mainLoop()</code>. Changes which are present on <code>Timer</code> off course.</p>
</div>
<div class="paragraph">
<p>In any case, this doesn&#8217;t solve the first problem, when the queue is empty and the timer thread blocked at <code>queue.take()</code>. There are potentially two ways of solving this.</p>
</div>
<div class="sect4">
<h5 id="_poison_pills">Poison pills</h5>
<div class="paragraph">
<p>One is to use poison pills in addition to the code block above. An ominous term.<br>
This concept is a common mechanism for cancellation. It is not used by <code>Timer</code>. It consists of an agrement between the clients and the timer threads that a particular message signals the cancellation. This message is the "Poison pill". In environments where there are several producers and consumers, it is harder to implement, but for our custom timer, with just one consumer thread (the timer thread), it is quite straightforward.</p>
</div>
<details id="cancellationFixed">
<summary class="title">Cancellation - Fixed</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="diff" class="language-diff hljs">+ import com.cmhteixeira.concurrent.timer.CustomTimer.PoisonPill
import java.util.Comparator
import java.util.concurrent.atomic.AtomicBoolean
import java.util.concurrent.{BlockingQueue, PriorityBlockingQueue}

class CustomTimer private (
  shutdown: AtomicBoolean,
  lock: Object,
  queue: BlockingQueue[(Runnable, Long)]
) {

  def cancel(): Unit = {
    shutdown.set(true)
+   queue.put((PoisonPill, 0))
+   lock.synchronized {
+     lock.notify()
+   }
  }

  def schedule(runnable: Runnable, delay: Long): Unit = {
    if (shutdown.get())
      throw new IllegalArgumentException("Timer already cancelled.")
    val thisTask = (runnable, System.currentTimeMillis() + delay)
    queue.put(thisTask)
    if (queue.peek() == thisTask) {
      lock.synchronized {
        lock.notify()
      }
    }
  }
}

object CustomTimer {

+ private object PoisonPill extends Runnable {
+   override def run(): Unit =
+     throw new RuntimeException("This will never happen.")
+ }

  private def comparator: Comparator[(Runnable, Long)] =
    new Comparator[(Runnable, Long)] {
      def compare(o1: (Runnable, Long), o2: (Runnable, Long)): Int =
        (o1._2 - o2._2).toInt
    }

  def apply(threadName: String): CustomTimer = {
    val shutdown = new AtomicBoolean(false)
    val lock: Object = new Object()
    val queue = new PriorityBlockingQueue[(Runnable, Long)](10, comparator)

    def mainLoop(): Unit =
      while (!shutdown.get()) {
        val tuple @ (runnableTask, whenToRun) = queue.take()
+       if (runnableTask.isInstanceOf[PoisonPill.type]) ()
        else {
          val timeToWait = whenToRun - System.currentTimeMillis()
          if (timeToWait &lt;= 0) runnableTask.run()
          else {
            lock.synchronized {
              lock.wait(timeToWait)
            }
            queue.offer(tuple)
          }
        }
      }

    val timerThread = new Thread(new Runnable { def run(): Unit = mainLoop() })
    timerThread.setName(threadName)
    timerThread.setDaemon(false)
    timerThread.start()
    new CustomTimer(shutdown, lock, queue)
  }
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>With the code above, the behaviour is quite similar to what <code>Timer</code> has, although timer does not use poison pills. Becuase <code>Timer</code> has its own bespoke queue, which it explictily locks, it doesn&#8217;t have our problem, and gets away only with solution this.</p>
</div>
</div>
<div class="sect4">
<h5 id="_thread_interruption">Thread interruption</h5>
<div class="paragraph">
<p>There is another solution to the problem. It is more interesting than the poison pill in the sense that the poison pill although a smart idea but does not leverage any obscure java language inner workings.<br>
The solution is to use Thread interruption. Thread interruption is a common way to implement cancellation. It is interesting because it leverages "native" support provided by the JVM itself, in constract with poison pills which are just a smart "trick" leveraging commonly known java source code.<br>
Java Threads have these three methods that someone with a reference to a <code>Thread</code> object can call: <code>Thread#interrupt()</code>, <code>Thread#isInterrupted()</code>, and <code>Thread#interrupted()</code>. Additionally, and this is really the important part, the JVM  documented behaviour states that when a thread is blocked by methods such as <code>&lt;Some-Object&gt;.wait()</code>, <code>&lt;Some-Object&gt;.wait(&lt;some-timeout&gt;)</code>, and then the thread is isterruped, the thread is able to detect it and wake-up early, throwing a <code>InterruptedException</code>.</p>
</div>
<div class="paragraph">
<p>This solves our original first problem when our timer thread is blocked at <code>lock.wait(&lt;timeWaiting&gt;)</code>. It also solves the second problem, because <code>queue.take()</code> also is able to "sense" thread interruption. We know this because of the documented behaviour of <code>PriorityBlockingQueue.take()</code>. Furthermore, inside of it, the mechanism is the same. That is, that <code>queue.take()</code> eventually calls a native blocking method (<code>wait()</code>), which is itself aware of interruption, and then it bubbles up.</p>
</div>
<details id="cancellationFixedWithInterrupts">
<summary class="title">Cancellation - Fixed with Thread interrupts</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="diff" class="language-diff hljs">import java.util.Comparator
- import java.util.concurrent.atomic.AtomicBoolean
import java.util.concurrent.{BlockingQueue, PriorityBlockingQueue}

class CustomTimer private (
- shutdown: AtomicBoolean,
+ threadHandle: Thread,
  lock: Object,
  queue: BlockingQueue[(Runnable, Long)]
) {

- def cancel(): Unit = shutdown.set(true)
+ def cancel(): Unit = threadHandle.interrupt()

  def schedule(runnable: Runnable, delay: Long): Unit = {
-   if (shutdown.get())
+   if (threadHandle.isInterrupted || !threadHandle.isAlive)
      throw new IllegalArgumentException("Timer already cancelled.")
    val thisTask = (runnable, System.currentTimeMillis() + delay)
    queue.put(thisTask)
    if (queue.peek() == thisTask) {
      lock.synchronized {
        lock.notify()
      }
    }
  }
}

object CustomTimer {

  private def comparator: Comparator[(Runnable, Long)] =
    new Comparator[(Runnable, Long)] {
      def compare(o1: (Runnable, Long), o2: (Runnable, Long)): Int =
        (o1._2 - o2._2).toInt
    }

  def apply(threadName: String): CustomTimer = {
-   val shutdown = new AtomicBoolean(false)
    val lock: Object = new Object()
    val queue = new PriorityBlockingQueue[(Runnable, Long)](10, comparator)

    def mainLoop(): Unit = {
+     try {
-       while (!shutdown.get()) {
+       while (!Thread.currentThread().isInterrupted) {
          val tuple @ (runnableTask, whenToRun) = queue.take()
          val timeToWait = whenToRun - System.currentTimeMillis()
          if (timeToWait &lt;= 0) runnableTask.run()
          else {
            lock.synchronized {
              lock.wait(timeToWait)
            }
            queue.offer(tuple)
          }
        }
+     } catch {
+         case _: InterruptedException =&gt; ()
+     } finally {
+       queue.clear()
+     }
    }

    val timerThread = new Thread(new Runnable { def run(): Unit = mainLoop() })
    timerThread.setName(threadName)
    timerThread.setDaemon(false)
    timerThread.start()
-   new CustomTimer(shutdown, lock, queue)
+   new CustomTimer(timerThread, lock, queue)
  }
}</code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_common_issues">Common issues</h3>
<div class="sect3">
<h4 id="_delayed_tasks">Delayed Tasks</h4>
<div class="paragraph">
<p>Because <code>Timer</code> and our custom timer only have one thread, if a task takes to long, the remaining tasks will not execute when they should. This should be self-evident from the previous detailed analysis.</p>
</div>
<details id="delayExecutionOfTask">
<summary class="title">Delay of execution of a task. See illustration <a href="#delayExecutionOfTaskImage">below</a>.</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="scala" class="language-scala hljs">import java.util.{Timer, TimerTask}
import scala.concurrent.duration._

object SomeTests extends App {

  val javaTimer = new Timer("FooBarTimer")

  javaTimer.schedule(
    new TimerTask { def run() = spin(70.second) },
    10.second.toMillis
  )

  javaTimer.schedule(
    new TimerTask { def run() = spin(20.second) },
    30.second.toMillis
  )
}</code></pre>
</div>
</div>
</div>
</details>
<div id="delayExecutionOfTaskImage" class="imageblock">
<div class="content">
<img src="./images/TimerThreadLane_DelayedTask.svg" alt="TimerThreadLane DelayedTask">
</div>
<div class="title">Figure 6. Thread states of a <code>java.util.Timer</code> for the listing <a href="#delayExecutionOfTask">above</a>. Task2 starts running after the intended time. Similar result using the custom timer.</div>
</div>
<div class="paragraph">
<p>The <code>ScheduledThreadPoolExecutor</code> lessens this problem by having multiple threads that can pick up tasks. <em>Lessens</em> is the appropriate word, as the problem is not fully solved.<br>
If the clients submit more tasks than there are threads, <strong>and</strong> each of these takes longer to run than the next is due, some task will start running later than intended.</p>
</div>
<div class="paragraph">
<p>This shortcoming is why <code>Timer</code> (and similarly for <code>ScheduledThreadPoolExecutor</code>) has two similar methods for scheduling periodic tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>schedule(&lt;task&gt;, &lt;delay&gt;, &lt;period&gt;)</code></p>
</li>
<li>
<p><code>scheduleAtFixedRate(&lt;task&gt;, &lt;delay&gt;, &lt;period&gt;)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the first, the <code>period</code> represents the time that should elapse between the end of one execution, to the beginning of the next execution of the task.<br>
For the second, the <code>period</code> represents the frequency (i.e., rate) at which the task should run.<br>
After some minutes of thinking, you will conclude that these two concepts are <strong>not</strong> equivalent in the scenario where the thread is busy running other tasks and starts running the task later than it should. For example, if we schedule a task to run a task every 1 minute, and the thread is currently busy running a task that takes 1 hour, then after that hour, in the first case, our task runs only once (and every minute thereafter), whilst on the 2nd case it runs 60 times to keep up.</p>
</div>
<div class="paragraph">
<p>While it is useful to know this, it is mostly irrelevant to the current analysis. We only care about the concurrency fundamentals of <code>Timer</code>. Once that is known, the remaining behaviour is a matter of time, and thinking a bit harder about corner cases.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exceptions_destroy_the_timer">Exceptions destroy the timer</h4>
<div class="paragraph">
<p>When a task being executed by <code>Timer</code> throws an exception, the thread dies, and the <code>Timer</code> itself behaves as if it had been cancelled; meaning no more tasks can be scheduled. In contrast, <code>ScheduledThreadPoolExecutor</code> takes a more defensive approach, and is able to recuperate and continue running normally.<br>
On our <a href="#cancellationFirstAttempt">current solution</a>, given that there is no <code>try/catch</code> block in sight, it&#8217;s clear that our thread will exit as well. Our offense is that we have no mechanism to stop any further task submissions. Less concerning, but also bad, is the fact the we don&#8217;t remove the tasks on the queue; these will never be run, and are obsolete references. Let&#8217;s add the last improvements in:</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_final_comparison">Final comparison</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Cherry-picked comparison points between the <code>Timer</code> and the timer we have developed</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top"><code>java.util.Timer</code></th>
<th class="tableblock halign-left valign-top">Our custom timer</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of threads</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thread created upon instantiation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared data structure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bespoke binary queue w/ locking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Existing blocking priority queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relies on <code>Object#wait(&lt;timeout&gt;)</code> for scheduling?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object used for locking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses the queue directly.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specific object, created with that objective</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relies on <code>System.currentTimeMillis()</code>?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-02-23 20:17:42 UTC
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/scala.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>